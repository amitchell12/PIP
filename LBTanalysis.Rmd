---
title: "LBT EWS Analysis"
author: "A.G. Mitchell"
date: "2022-10-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(reshape2)
library(ggpol)
library(ggpubr)
library(Rmisc)
library(gghalves)
library(RColorBrewer)
library(gghalves)
library(ez)
library(psychReport)
```

# Load data
```{r}
aPath <- '/Users/au706616/Documents/Experiments/PIPTOT/analysis/'
fileName <- 'LBT_compiled-data.csv'
all_dat <- read.csv(file.path(aPath,fileName)) 
```

```{r}
## First, code bisection error
#all_dat$bisect_x_scaled <- all_dat$bisect_x/all_dat$av_rate
# before calculating bisection error check bisect_x and calib_loc_mid make sense
#bisect_check <- aggregate(bisect_x_scaled ~ prolific_id*left_mm*right_mm*calib_loc_midy_x, 
 #                         mean, data = all_dat)
# yep that seems to make sense, now convert and do the same
all_dat$bisect_error <- all_dat$bisect_x - all_dat$calib_loc_midy_x

# then scale the error by coordinate change rate calculated in previous step
all_dat$bisect_error_scaled <- all_dat$bisect_error/all_dat$av_rate
all_dat$bisect_error_scaled <- all_dat$bisect_error_scaled/all_dat$pix_permm #transfer to mm

bisect_check <- aggregate(bisect_error_scaled ~ prolific_id*left_mm*right_mm, 
                          mean, data = all_dat)
bisect_check$offset <- (bisect_check$left_mm + bisect_check$right_mm)/2
# yes this step makes sense for most people, plot it just incase

all_plot <- ggplot(bisect_check, aes(group = as.factor(offset), colour = as.factor(offset))) +
  geom_point(aes(bisect_error_scaled, y = 0)) +
  xlim(-75,75) +
  theme_bw() +
  facet_wrap(~prolific_id)
all_plot
```

# some more filtering - remove participants with too few trials
```{r}
# remove all trials with response > 3000ms
all_dat <- dplyr::filter(all_dat, response_time < 3000)

# identify any participants with too few trials, less than 32 per condition
trials <- aggregate(bisect_error ~ prolific_id*pip*block, length, data = all_dat)
id_x <- trials$prolific_id[trials$bisect_error < 32]

# check all participants have levels of both factors (block and tone)
nblock <- aggregate(bisect_error ~ block*prolific_id, length, data = all_dat)
nblock <- nblock %>% 
  group_by(prolific_id) %>%
  tally()

ntone <- aggregate(bisect_error ~ pip*prolific_id, length, data = all_dat)
ntone <- ntone %>% 
  group_by(prolific_id) %>%
  tally()

# and remove those that don't
id_x <- append(id_x, nblock$prolific_id[nblock$n < 2])
id_x <- append(id_x, ntone$prolific_id[nblock$n < 2])

all_dat <- filter(all_dat, !(prolific_id %in% id_x))
n <- count(all_dat, 'prolific_id')
length(n$prolific_id)

# recode ID
all_dat$prolific_id <- as.factor(all_dat$prolific_id)
all_dat$ID <- as.character(as.numeric(all_dat$prolific_id))
all_dat <- all_dat[order(all_dat$ID), ]
rownames(all_dat) <- NULL
```

# ANALYSIS
End point weightings on both block and tone conditions
```{r}
# recode bisection variables
all_dat$P <- all_dat$bisect_error_scaled
all_dat$L <- all_dat$left_mm
all_dat$R <- all_dat$right_mm
all_dat$ID <- as.factor(all_dat$ID)

# tone and block recoding
all_dat$cond[all_dat$block == 1 & all_dat$pip == 0] <- '1' #block early, tone blank
all_dat$cond[all_dat$block == 1 & all_dat$pip == 1] <- '2' #block early, tone sound
all_dat$cond[all_dat$block == 2 & all_dat$pip == 0] <- '3' #block late, tone blank
all_dat$cond[all_dat$block == 2 & all_dat$pip == 1] <- '4' #block late, tone sound

all_dat$block <- ifelse(all_dat$block == 1, 'EARLY', 'LATE')
all_dat$tone <- ifelse(all_dat$pip == 0, 'BLANK', 'SOUND')

# as factors
all_dat$cond <- as.factor(all_dat$cond)
all_dat$block <- as.factor(all_dat$block)
all_dat$tone <- as.factor(all_dat$tone)

# End point weightings analysis
# TONE
EW_DV <- read.csv(text="ID,tone,block,cond,NUMTRIALS,rsq,k,dPL,dPR")

for(ID in levels(all_dat$ID)){
  for(cond in levels(all_dat$cond)){
    tmp <- all_dat[all_dat$ID == ID & all_dat$cond==cond, 
                   c("bisect_error_scaled","pix_permm","P","L","R")]
    model <- lm(P~L+R, data=tmp)
    #tone = tmp$tone
    #block = tmp$block
    NUMTRIALS <- nrow(tmp)
    rsq <- summary(model)$r.squared
    k <- as.numeric(coefficients(model)[1])
    dPL <- as.numeric(coefficients(model)[2])
    dPR <- as.numeric(coefficients(model)[3])
    
    #add to dataframe
    EW_DV <- rbind(EW_DV, cbind.data.frame(ID,cond,NUMTRIALS,rsq,k,dPL,dPR))
  }
}

#calculate composites
EW_DV$EWB <- EW_DV$dPR-EW_DV$dPL
EW_DV$EWS <- EW_DV$dPR+EW_DV$dPL

EW_DV <- EW_DV %>% 
  rowwise() %>%
  mutate(
    FILT = case_when(rsq < .7 ~ TRUE,
               EWB > .5 ~ TRUE,
               EWS < .5 ~ TRUE
           ))

# flag ids for removal
id_filt <- EW_DV$ID[EW_DV$FILT == TRUE]
id_filt <- id_filt[!is.na(id_filt)]


# calculate final n of participants that can be used (this will be low)
all_dat <- filter(all_dat, !(ID %in% id_filt))
EW_DV <- filter(EW_DV, !(ID %in% id_filt))
final_n <- count(all_dat, 'ID')
length(final_n$ID) #final number of participants
```

# Reliability and distribution checks on data
```{r}
# plot EWS distribution
ggplot(EW_DV, aes(EWB)) +
  geom_density() +
  theme_bw()

ggplot(EW_DV, aes(EWS)) +
  geom_density() +
  theme_bw()

# plot all dPL and dPR 
ggplot(EW_DV, aes(dPR, dPL)) +
  geom_hline(yintercept = .5, alpha = .5, size = .7) +
  geom_vline(xintercept = .5, alpha = .5, size = .7) +
  geom_abline(intercept = 0, slope = 1, alpha = .5, size = .7,
              linetype = 'dashed') +
  geom_point(shape = 21, alpha = .8, size = 2) +
  ylim(0,1) + 
  xlim(0,1) +
  labs(x = 'Right end-point weighting',
       y = 'Left end-point weighting') +
  theme_bw() + 
  theme(axis.title = element_text(size = 12),
        axis.text = element_text(size = 10)) -> end_points_plot
end_points_plot
# save
ggsave('end_points.png', end_points_plot, device = NULL, path = aPath,
       width = 7, height = 6, dpi = 600)

# test re-test
# clearly define conditions in main data set
EW_DV$block <- ifelse(EW_DV$cond == '1' | EW_DV$cond == '2', 'EARLY', 'LATE')
EW_DV$tone <- ifelse(EW_DV$cond == '1' | EW_DV$cond == '3', 'BLANK', 'SOUND')

block1 <- filter(EW_DV, block == 'EARLY')
names(block1)[8] <- 'EWB_1'
names(block1)[9] <- 'EWS_1'
block2 <- filter(EW_DV, block == 'LATE')
names(block2)[8] <- 'EWB_2'
names(block2)[9] <- 'EWS_2'

DF <- merge(block1, block2, by = 'ID')

# run test re-test

cor(DF$EWS_1, DF$EWS_2)
cor(DF$EWB_1, DF$EWB_2)
```

# First, check for pseudoneglect
```{r}
# EWB
pseudo <- aggregate(EWB ~ ID, mean, data = EW_DV)
#pseudo$xj <- jitter(0, amount = .1)

# run t-test
# EWS - we have pseudoneglect
EWB_test <- t.test(pseudo$EWB, mu = 0, alternative = 'less')
EWB_test

# Now for DBE - first we need to calculate this
# calculate offset of the line - to subtract P from
all_dat$offset <- (all_dat$left_mm + all_dat$right_mm)/2
all_dat$DBE <- all_dat$bisect_error_scaled - all_dat$offset

DBE_line <- aggregate(DBE ~ ID*cond*block*tone, mean, data = all_dat)
# average across all and get pseudoneglect
DBE <- aggregate(DBE ~ ID, mean, data = DBE_line)

# DBE test
DBE_test <- t.test(DBE$DBE, mu = 0, alternative = 'less')
DBE_test

# add DBE to pseudo then plot
pseudo <- merge(pseudo, DBE, by = 'ID')
# for compete picture, add EWS
EWS <- aggregate(EWS ~ ID, mean, data = EW_DV)
pseudo <- merge(pseudo, EWS, by = 'ID')
# melt
pseudo <- melt(pseudo, value.name = 'BIAS')

# summarise pseudo
pseudo_sum <- summarySEwithin(data = pseudo, measurevar = 'BIAS', withinvars = 'variable')

# get effect sizes for all
# effect size
pseudo_sum <- pseudo_sum %>%
  mutate(es = BIAS/sd)
```

# Plot dependent variables
```{r}
# change variable names for pseudo
#pseudo <- pseudo %>% 
#  rowwise() %>%
#  mutate(
#    NAME = case_when(variable == 'EWB' ~ 'BIAS',
#                     variable == 'DBE' ~ 'ERROR',
#                     variable == 'EWS' ~ 'SUM'
#    ))


# add h line to the data
data_hline <- data.frame(variable = unique(pseudo$variable),  # Create data for lines
                         hline = c(0, 0, 1))
# ordering
pseudo$variable <- factor(pseudo$variable, levels = c('EWS','EWB','DBE'))
# jittering points
pseudo$xj <- jitter(1, amount = .1)

nudge1 = .12
nudge2 = -.12

# plot the distribution of all data (and means?)
ggplot(data = pseudo, aes(group = variable)) +
  geom_jitter(aes(x = 1, y = BIAS), 
              width = .05, shape = 21, size = 2.5, alpha = .8) +
  facet_wrap(~variable, scales = "free") +
  # violin plots
  geom_half_violin(data = pseudo %>% filter(variable == 'EWS'),
                   aes(x = 1, y = BIAS),
                   position = position_nudge(nudge2)) +
  geom_half_violin(data = pseudo %>% filter(variable == 'EWB'),
                   aes(x = 1, y = BIAS),
                   position = position_nudge(nudge2)) +
  geom_half_violin(data = pseudo %>% filter(variable == 'DBE'),
                   aes(x = 1, y = BIAS),
                   position = position_nudge(nudge2)) +
  # add summary stats
  geom_point(data = pseudo_sum,
             aes(x = 1, y = BIAS),
             position = position_nudge(nudge2), size = 4) +
  geom_errorbar(data = pseudo_sum,
                aes(x = 1, ymin = BIAS-ci, ymax = BIAS+ci),
                width = .04, size = 1.1, position = position_nudge(nudge2)) +
  labs(x = '', y = 'Measurement') +
  theme_classic() +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 13),
        axis.title = element_text(size = 16),
        strip.text.x = element_text(size = 15)) -> m_plot
  

m_plot <- m_plot +   geom_hline(data = data_hline,
             aes(yintercept = hline), linetype = 'dashed', alpha = .6, size = 1.2)
m_plot

# arrange with end_point_plot
## THIS NEEDS EDITING - use grid.arrange?
#m1_plot <- ggarrange(end_points_plot, m_plot,
#                     nrow = 1, ncol = 2,
#                     labels = c('a.','b.'),
#                     widths = c(.5,1),
#                     layout_matrix = (cbind(c(1,NA),
#                                            c(2,2))))
#m1_plot

# save plot
ggsave('Measurements.png', m_plot, device = NULL, path = aPath,
       width = 10, height = 5.5, dpi = 600)


```

# Hypothesis 1 - EWS
# Analysis across blocks
```{r}
# colour
blues <- brewer.pal(9, "Blues")
# isolate silent trials only
tonic <- filter(EW_DV, tone == 'BLANK')
# if tone trials are included in the analysis - the effect of TOT is significant
#tonic <- aggregate(EWS~block*ID, mean, data = EW_DV)
# recode block
tonic$block <- ifelse(tonic$block == 'EARLY', 1, 2)
tonic$xj <- jitter(tonic$block, .2)
sum_tonic <- summarySEwithin(data = tonic, measurevar = 'EWS', withinvars = 'block')

# first plot EWS by block
ggplot(tonic, aes(group = ID, colour = as.factor(block), fill = as.factor(block))) +
  # all data
  geom_half_violin(aes(as.factor(block), EWS, group = block),
                   position = position_nudge(x = -.05), side = "l", 
                   alpha = .4) +
  geom_point(aes(xj, EWS), position = position_nudge(.05), shape = 21, alpha = .7) +
  # summar data
  geom_point(data = sum_tonic, aes(block, EWS), 
             position = position_nudge(-.05), colour = 'grey5', size = 2.5) +
  geom_errorbar(data = sum_tonic, 
                aes(block, y = EWS, ymin = EWS-ci, ymax = EWS+ci), 
                position = position_nudge(-.05), size = 0.7, 
                colour = 'grey5', width = .03) +
  # connect the two lines
  geom_line(data = sum_tonic, 
            aes(x = block, y = EWS), 
            size = 0.75, position = position_nudge(-.05), colour = 'grey5') +
  scale_colour_manual(values = c('grey50', 'grey20')) +
  scale_fill_manual(values = c('grey90', 'grey60')) +
  #scale_colour_manual(values = c(blues[4], blues[7])) +
  #scale_fill_manual(values = c(blues[4], blues[7])) +
  scale_x_discrete(breaks = c(1,2), labels = c('Early', 'Late')) +
  labs(x = '') +
  #ylim(.7,1.2) +
  theme_classic() +
  theme(legend.position = 'none',
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12)) -> tonic_plot

# is this difference at all significant??
# cast tonic
tonic_wide <- dcast(tonic, ID ~ block, value.var = "EWS")
# rename columns
names(tonic_wide)[2] <- 'EARLY'
names(tonic_wide)[3] <- 'LATE'
# difference between early and late
tonic_wide$DIFF <- tonic_wide$LATE - tonic_wide$EARLY
block_test <- t.test(tonic_wide$DIFF, mu = 0, alternative = 'less')
block_test

# now plot difference and put together!
# summary of difference
tonic_diff <- summarySE(data = tonic_wide, measurevar = 'DIFF', na.rm = TRUE)
# get effect size
tonic_diff <- tonic_diff %>% mutate(es = DIFF/sd)
tonic_diff

ggplot(tonic_diff) +
  geom_hline(aes(yintercept = 0), colour = 'gray50', size = 1, 
             linetype = 'dashed') +
  geom_point(aes(0, DIFF), size = 3.3, colour = 'grey5') +
  geom_linerange(aes(0, ymin = DIFF-ci, ymax = DIFF+ci), 
                colour = 'grey5', size = .8) +
 #xlim(-.025,.025) +
  ylim(-.05,.05) +
  labs(x = '', y = 'Difference (Block 2 - Block 1)') +
  scale_x_continuous(breaks = 0, labels = '') +
  theme_classic() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))-> tonic_diff_plot

tonic_all <- ggarrange(tonic_plot, tonic_diff_plot,
          ncol = 2, nrow = 1,
          widths = c(1, 0.5))
#tonic_all <- annotate_figure(tonic_all, 
#                             top = text_grob("SUM: Time on Task", size = 14))
tonic_all
```

# Analysis across tones
```{r}
# colour
grees <- brewer.pal(9, "Greens")
# first, average silent and toned trials by block
phasic_wide <- dcast(EW_DV, ID ~ block*tone, value.var = 'EWS')
phasic_wide$BLANK <- rowMeans(phasic_wide[, c(2,4)])
phasic_wide$SOUND <- rowMeans(phasic_wide[, c(3,5)])

# first plot EWS by tone
# melt
phasic <- phasic_wide[, c(1,6,7)]
#phasic <- phasic_wide[, c(1:3)] #taking results from the first block only
phasic <- melt(phasic, value.name = 'EWS', variable.name = 'tone')
# recode tone
#phasic$tone <- ifelse(phasic$tone == 'EARLY_BLANK', 1, 2)
phasic$tone <- ifelse(phasic$tone == 'BLANK', 1, 2)
phasic$xj1 <- jitter(phasic$tone, .2)

# summary data
sum_phasic <- summarySEwithin(data = phasic, measurevar = 'EWS', withinvars = 'tone')

# first plot EWS by block
ggplot(phasic, aes(group = ID, colour = as.factor(tone), fill = as.factor(tone))) +
  # all data
  geom_half_violin(aes(as.factor(tone), EWS, group = tone),
                   position = position_nudge(x = -.05), side = "l", 
                   alpha = .4) +
  geom_point(aes(xj1, EWS), position = position_nudge(.05), shape = 21, alpha = .7) +
  # summar data
  geom_point(data = sum_phasic, aes(tone, EWS), 
             position = position_nudge(-.05), colour = 'grey5', size = 2.5) +
  geom_errorbar(data = sum_phasic, 
                aes(tone, y = EWS, ymin = EWS-ci, ymax = EWS+ci), 
                position = position_nudge(-.05), size = 0.7, 
                colour = 'grey5', width = .03) +
  # connect the two lines
  geom_line(data = sum_phasic, 
            aes(x = tone, y = EWS), 
            size = 0.75, position = position_nudge(-.05), colour = 'grey5') +
  scale_colour_manual(values = c('grey50', 'grey20')) +
  scale_fill_manual(values = c('grey90', 'grey60')) +
  scale_x_discrete(breaks = c(1,2), labels = c('No Tone', 'Tone')) +
  labs( x = '') +
  #ylim(.8,1.2) +
  theme_classic() +
  theme(legend.position = 'none',
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        title = element_text(size = 14)) -> phasic_plot

# is this difference at all significant??
# difference between early and late
phasic_wide$DIFF <- phasic_wide$SOUND - phasic_wide$BLANK
#phasic_wide$DIFF <- phasic_wide$EARLY_SOUND - phasic_wide$EARLY_BLANK
tone_test <- t.test(phasic_wide$DIFF, mu = 0, alternative = 'greater')
tone_test

# now plot difference and put together!
# summary of difference
phasic_diff <- summarySE(data = phasic_wide, measurevar = 'DIFF', na.rm = TRUE)
# get effect size
phasic_diff <- phasic_diff %>% mutate(es = DIFF/sd)
phasic_diff

ggplot(phasic_diff) +
  geom_hline(aes(yintercept = 0), colour = 'gray50', 
             linetype = 'dashed', size = 1) +
  geom_point(aes(0, DIFF), size = 3.3, colour = 'grey5') +
  geom_linerange(aes(0, ymin = DIFF-ci, ymax = DIFF+ci), 
                colour = 'grey5', size = .8) +
 #xlim(-.025,.025) +
  ylim(-.05,.05) +
  labs(x = '', y = 'Difference (Tone - No tone)') +
  scale_x_continuous(breaks = 0, labels = '') +
  theme_classic() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))-> phasic_diff_plot

phasic_all <- ggarrange(phasic_plot, phasic_diff_plot,
          ncol = 2, nrow = 1,
          widths = c(1, 0.5))
#phasic_all <- annotate_figure(phasic_all, 
#                             top = text_grob("SUM: Tone", size = 14))
phasic_all
```

# Combine tonic and phasic EWS plots for manuscript
```{r}
EWS_fig3 <- ggarrange(tonic_all, phasic_all,
                      ncol = 1, nrow = 2,
                      labels = c('a.', 'b.'))
EWS_fig3

ggsave('EWS_fig3.png', EWS_fig3, device = NULL, path = aPath,
       width = 8.5, height = 9, dpi = 600)
```


# Run the same analyses as above, but this time on EWB
# Tonic
```{r}
# colours
purps <- brewer.pal(9, "Purples")
orans <- brewer.pal(9, "Oranges")
# across blocks
# isolate silent trials only
sum_tonic_bias <- summarySEwithin(data = tonic, measurevar = 'EWB', withinvars = 'block')

# plot the same plot for EWB
ggplot(tonic, aes(group = ID, colour = as.factor(block), 
                  fill = as.factor(block))) +
  # all data
  geom_half_violin(aes(as.factor(block), EWB, group = block),
                   position = position_nudge(x = -.05), side = "l", 
                   alpha = .4) +
  geom_point(aes(xj, EWB), position = position_nudge(.05), shape = 21, alpha = .7) +
  # summar data
  geom_point(data = sum_tonic_bias, aes(block, EWB), 
             position = position_nudge(-.05), colour = 'grey5', size = 2.5) +
  geom_errorbar(data = sum_tonic_bias, 
                aes(block, y = EWB, ymin = EWB-ci, ymax = EWB+ci), 
                position = position_nudge(-.05), size = 0.8, 
                width = .03, colour = 'grey5') +
  # connect the two lines
  geom_line(data = sum_tonic_bias, 
            aes(x = block, y = EWB), 
            size = 0.75, position = position_nudge(-.05), colour = 'grey5') +
  scale_colour_manual(values = c('grey50', 'grey20')) +
  scale_fill_manual(values = c('grey90', 'grey60')) +
  scale_x_discrete(breaks = c(1,2), labels = c('Early', 'Late')) +
  labs(x = '', y = 'EWB') +
  ylim(-.15,.10) +
  theme_classic() +
  theme(legend.position = 'none',
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12)) -> tonic_bias_plot


# is this difference at all significant??
# cast tonic
tonic_bias <- dcast(tonic, ID ~ block, value.var = "EWB")
# rename columns
names(tonic_bias)[2] <- 'EARLY'
names(tonic_bias)[3] <- 'LATE'
# difference between early and late
tonic_bias$DIFF <- tonic_bias$EARLY - tonic_bias$LATE
block_bias_test <- t.test(tonic_bias$DIFF, mu = 0, alternative = 'greater')
block_bias_test

tonic_bias_diff <- summarySE(data = tonic_bias, measurevar = 'DIFF', na.rm = TRUE)

# get effect size
tonic_bias_diff <- tonic_bias_diff %>% mutate(es = DIFF/sd)
tonic_bias_diff

# now plot difference and put together!
ggplot(tonic_bias_diff) +
  geom_hline(aes(yintercept = 0), colour = 'gray50', 
             linetype = 'dashed', size = 1) +
  geom_point(aes(0, DIFF), size = 3.3, colour = 'grey5') +
  geom_linerange(aes(0, ymin = DIFF-ci, ymax = DIFF+ci), 
                colour = 'grey5', size = .8) +
 #xlim(-.025,.025) +
  ylim(-.05,.05) +
  labs(x = '', y = 'Difference (Block 2 - Block 1)') +
  scale_x_continuous(breaks = 0, labels = '') +
  theme_classic() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))-> tonicB_diff_plot

tonic_bias_all <- ggarrange(tonic_bias_plot, tonicB_diff_plot,
                  ncol = 2, nrow = 1,
                  widths = c(1, 0.5))
#phasic_all <- annotate_figure(phasic_all, 
#                             top = text_grob("SUM: Tone", size = 14))
tonic_bias_all
```

# Phasic
```{r}
# across tone
# first, average silent and toned trials by block
phasic_bias_wide <- dcast(EW_DV, ID ~ block*tone, value.var = 'EWB')
phasic_bias_wide$BLANK <- rowMeans(phasic_bias_wide[, c(2,4)])
phasic_bias_wide$SOUND <- rowMeans(phasic_bias_wide[, c(3,5)])

# first plot EWS by tone
# melt
phasic_bias <- phasic_bias_wide[, c(1,6,7)]
phasic_bias <- melt(phasic_bias, value.name = 'EWB', variable.name = 'tone')
# recode tone
phasic_bias$tone <- ifelse(phasic_bias$tone == 'BLANK', 1, 2)
phasic_bias$xj1 <- jitter(phasic_bias$tone, .2)
# summary data
sum_phasic_bias <- summarySEwithin(data = phasic_bias, measurevar = 'EWB', withinvars = 'tone')

# plot the same plot for EWB
ggplot(phasic_bias, aes(group = ID, colour = as.factor(tone), fill = as.factor(tone))) +
  # all data
  geom_half_violin(aes(as.factor(tone), EWB, group = tone),
                   position = position_nudge(x = -.05), side = "l", 
                   alpha = .4) +
  geom_point(aes(xj1, EWB), position = position_nudge(.05), shape = 21, alpha = .7) +
  # summar data
  geom_point(data = sum_phasic_bias, aes(tone, EWB), 
             position = position_nudge(-.05), colour = 'grey5', size = 2.5) +
  geom_errorbar(data = sum_phasic_bias, 
                aes(tone, y = EWB,  ymin = EWB-ci, ymax = EWB+ci), 
                position = position_nudge(-.05), size = 0.8, 
                colour = 'grey5', width = .03) +
  # connect the two lines
  geom_line(data = sum_phasic_bias, 
            aes(x = tone, y = EWB), 
            size = 0.75, position = position_nudge(-.05), colour = 'grey5') +
  scale_colour_manual(values = c('grey50', 'grey20')) +
  scale_fill_manual(values = c('grey90', 'grey60')) +
  scale_x_discrete(breaks = c(1,2), labels = c('No tone', 'Tone')) +
  labs(x = '', y = 'EWB') +
  ylim(-.15,.10) +
  theme_classic() +
  theme(legend.position = 'none',
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12)) -> phasic_bias_plot

# is this difference at all significant??
# difference between early and late
phasic_bias_wide$DIFF <- phasic_bias_wide$SOUND - phasic_bias_wide$BLANK
# get effect size
phasic_bias_diff <- summarySE(data = phasic_bias_wide, measurevar = 'DIFF', na.rm = TRUE)
phasic_bias_diff <- phasic_bias_diff %>% mutate(es = DIFF/sd)
phasic_bias_diff

tone_bias_test <- t.test(phasic_bias_wide$DIFF, mu = 0, alternative = 'less')
tone_bias_test

# now plot difference and put together!
ggplot(phasic_bias_diff) +
  geom_hline(aes(yintercept = 0), colour = 'gray50',
               size = 1, linetype = 'dashed') +
  geom_point(aes(0, DIFF), size = 3.5, colour = 'grey5') +
  geom_linerange(aes(0, ymin = DIFF-ci, ymax = DIFF+ci), colour = 'grey5', size = 1) +
 #xlim(-.025,.025) +
  ylim(-.05,.05) +
  labs(x = '', y = 'Difference (Tone - No tone)') +
  scale_x_continuous(breaks = 0, labels = '') +
  theme_classic() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))-> phasicB_diff_plot

phasic_bias_all <- ggarrange(phasic_bias_plot, phasicB_diff_plot,
          ncol = 2, nrow = 1,
          widths = c(1, 0.5))
phasic_bias_all <- annotate_figure(phasic_bias_all, 
                             top = text_grob("BIAS: Tone", size = 14))
phasic_bias_all
```

# Combine all EWS and EWB plots for manuscript
```{r}
EWSplot <- ggarrange(tonic_all, phasic_all,
                     ncol = 1, nrow = 2,
                     labels = c('a.','b.'))

EWBplot <- ggarrange(tonic_bias_all, phasic_bias_all,
                     ncol = 1, nrow = 2,
                     labels = c('a.','b.'))

ggsave('EWS_fig3.png', EWSplot, device = NULL, path = aPath,
       width = 6, height = 8, dpi = 600)
ggsave('EWS_fig4.png', EWBplot, device = NULL, path = aPath,
       width = 6, height = 8, dpi = 600)
```

##### EXPLORATORY ANALYSES #####
# Interaction effects for EWS
```{r}
all_cond_wide <- phasic_wide[, c(1:5) ,]
# melt
all_cond <- melt(all_cond_wide, value.name = 'EWS')
# transform variable to numerical
all_cond <- all_cond %>% 
  rowwise() %>%
  mutate(
    COND = case_when(variable == 'EARLY_BLANK' ~ '1',
                     variable == 'EARLY_SOUND' ~ '2',
                     variable == 'LATE_BLANK' ~ '3',
                     variable == 'LATE_SOUND' ~ '4'
           ))
all_cond$BLOCK <- ifelse(all_cond$COND == '1' | all_cond$COND == '2', '1', '2')
all_cond$TONE <- ifelse(all_cond$COND == '1' | all_cond$COND == '3', '1', '2')
all_cond$BLOCK <- as.factor(all_cond$BLOCK)
all_cond$TONE <- as.factor(all_cond$TONE)

# summarise
sum_all <- summarySEwithin(all_cond, measurevar = 'EWS', withinvars = 'COND')
# identify blocks and tones
sum_all$BLOCK <- ifelse(sum_all$COND == '1' | sum_all$COND == '2', 'Early', 'Late')
sum_all$TONE <- ifelse(sum_all$COND == '1' | sum_all$COND == '3', 'No tone', 'Tone')
sum_all

# ANOVA of all effects
EWSanov <- ezANOVA(
  data = all_cond
  , dv = .(EWS)
  , wid = .(ID)
  , within = .(BLOCK, TONE)
  , type = 3,
  return_aov = TRUE,
  detailed = TRUE
)

#print(EWSanov$ANOVA)

#EWSanov$ANOVA
#EWSanov$`Mauchly's Test for Sphericity`
#EWSanov$`Sphericity Corrections`
aovEWS <- aovEffectSize(EWSanov, effectSize = "pes")
aovDispTable(aovEWS)

```

# Plot ANOVA
```{r}
# plot this bad boy
ggplot(sum_all, aes(BLOCK, EWS, group = TONE, colour = TONE)) +
  geom_point(position = position_dodge(.2), size = 3) +
  geom_errorbar(aes(BLOCK, ymin = EWS-ci, ymax = EWS+ci),
                position = position_dodge(.2), width = .1, size = 0.75) +
  geom_line(aes(x = BLOCK, y = EWS), 
            size = 1, position = position_dodge(.2)) +
  scale_colour_manual(values = c('grey70', 'grey20')) +
  ylim(0.98, 1.05) +
  labs(x = '') +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = 'none',
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        title = element_text(size = 14),
        legend.text = element_text(size = 12)) -> inter_plot
inter_plot
```

# Interaction effects for EWS
```{r}
all_bias_wide <- phasic_bias_wide[, c(1:5) ,]
# melt
all_bias_wide <- melt(all_bias_wide, value.name = 'EWB')
# transform variable to numerical
all_bias_wide <- all_bias_wide %>% 
  rowwise() %>%
  mutate(
    COND = case_when(variable == 'EARLY_BLANK' ~ '1',
                     variable == 'EARLY_SOUND' ~ '2',
                     variable == 'LATE_BLANK' ~ '3',
                     variable == 'LATE_SOUND' ~ '4'
           ))
all_bias_wide$BLOCK <- ifelse(all_bias_wide$COND == '1' | all_bias_wide$COND == '2', '1', '2')
all_bias_wide$TONE <- ifelse(all_bias_wide$COND == '1' | all_bias_wide$COND == '3', '1', '2')
all_bias_wide$BLOCK <- as.factor(all_bias_wide$BLOCK)
all_bias_wide$TONE <- as.factor(all_bias_wide$TONE)

# summarise
sum_bias_all <- summarySEwithin(all_bias_wide, measurevar = 'EWB', withinvars = 'COND')
# identify blocks and tones
sum_bias_all$BLOCK <- ifelse(sum_bias_all$COND == '1' | sum_bias_all$COND == '2', 'Early', 'Late')
sum_bias_all$TONE <- ifelse(sum_bias_all$COND == '1' | sum_bias_all$COND == '3', 'No tone', 'Tone')

# ANOVA of all effects
EWBanov <- ezANOVA(
  data = all_bias_wide
  , dv = .(EWB)
  , wid = .(ID)
  , within = .(BLOCK, TONE)
  , type = 3,
  return_aov = TRUE,
  detailed = TRUE
)

#print(EWSanov$ANOVA)

#EWBanov$ANOVA
#EWBanov$`Mauchly's Test for Sphericity`
#EWBanov$`Sphericity Corrections`
aovEWB <- aovEffectSize(EWBanov, effectSize = "pes")
aovDispTable(aovEWB)
```

# Plot ANOVA
```{r}
# plot this bad boy
ggplot(sum_bias_all, aes(BLOCK, EWB, group = TONE, colour = TONE)) +
  geom_point(position = position_dodge(.2), size = 3) +
  geom_errorbar(aes(BLOCK, ymin = EWB-ci, ymax = EWB+ci),
                position = position_dodge(.2), width = .1, size = 0.75) +
  geom_line(aes(x = BLOCK, y = EWB), 
            size = 1, position = position_dodge(.2)) +
  scale_colour_manual(values = c('grey70', 'grey20')) +
  ylim(-.05, .01) +
  labs(x = '') +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = 'none',
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        title = element_text(size = 14),
        legend.text = element_text(size = 12)) -> inter_bias_plot
inter_bias_plot
```

## REACTION TIMES
Run the same ANOVA on reaction time data

# Extracting reaction times
```{r}
# plot all RT, are they skewed?
ggplot(all_dat) +
  geom_density(aes(response_time)) +
  theme_bw()
# yes, should use median, but will record mean anyway

# average reaction time across trials
rt_dat <- aggregate(response_time~ID*block*pip, mean, data = all_dat)

# add median RT
med <- aggregate(response_time~ID*block*pip, median, data = all_dat)
# rename
med <- med %>% 
  rename(RT_med = response_time)

# compile and rename
rt_dat <- rt_dat %>% 
  left_join(med, by = c('ID', 'block', 'pip')) %>% 
  rename(BLOCK = block,
          TONE = pip,
          RT_mean = response_time) %>% 
  mutate(TONE = ifelse(TONE == 0, 'No tone', 'Tone'),
         BLOCK = ifelse(BLOCK == 'EARLY', 'Early', 'Late'),
         COND = case_when(BLOCK == 'Early' & TONE == 'No tone' ~ '1',
                     BLOCK == 'Early' & TONE == 'Tone' ~ '2',
                     BLOCK == 'Late' & TONE == 'No tone' ~ '3',
                     BLOCK == 'Late' & TONE == 'Tone' ~ '4'
           )) 
head(rt_dat)
```
# Summary and RT ANOVA
```{r}
# summarise
sum_rt <- summarySEwithin(rt_dat, measurevar = 'RT_med', withinvars = 'COND')
# identify blocks and tones
sum_rt$BLOCK <- ifelse(sum_rt$COND == '1' | sum_rt$COND == '2', 'Early', 'Late')
sum_rt$TONE <- ifelse(sum_rt$COND == '1' | sum_rt$COND == '3', 'No tone', 'Tone')
sum_rt

# factors
rt_dat$ID <- as.factor(rt_dat$ID)
rt_dat$BLOCK <- as.factor(rt_dat$BLOCK)
rt_dat$TONE <- as.factor(rt_dat$TONE)
# ANOVA of RT
RTanov <- ezANOVA(
  data = rt_dat
  , dv = .(RT_med)
  , wid = .(ID)
  , within = .(BLOCK, TONE)
  , type = 3,
  return_aov = TRUE,
  detailed = TRUE
)

#print(EWSanov$ANOVA)

#EWBanov$ANOVA
#EWBanov$`Mauchly's Test for Sphericity`
#EWBanov$`Sphericity Corrections`
aovRT <- aovEffectSize(RTanov, effectSize = "pes")
aovDispTable(aovRT)
```

# ANOVA figure
```{r}
# change RT to second for plotting purposes
sum_rts <- sum_rt %>% 
  mutate(RT_med = RT_med/1000,
         sd = sd/1000,
         ci = ci/1000,
         se = se/1000)

ggplot(sum_rts, aes(BLOCK, RT_med, group = TONE, colour = TONE)) +
  geom_point(position = position_dodge(.2), size = 3) +
  geom_errorbar(aes(BLOCK, ymin = RT_med-ci, ymax = RT_med+ci),
                position = position_dodge(.2), width = .1, size = 0.75) +
  geom_line(aes(x = BLOCK, y = RT_med), 
            size = 1, position = position_dodge(.2)) +
  scale_colour_manual(values = c('grey70', 'grey20')) +
  ylim(1.4, 1.8) +
  labs(x = '', y = 'Reaction time (sec)') +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = 'right',
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        title = element_text(size = 14),
        legend.text = element_text(size = 12)) -> inter_rt_plot
inter_rt_plot
```

# Combine all exploratory results figures into one for publication
```{r}
explPlot1 <- ggarrange(inter_plot, inter_bias_plot,
                       ncol = 2, nrow = 1,
                       labels = c('a.','b.'))

explPlot2 <- ggarrange(NA, inter_rt_plot, NA,
                      ncol = 3, nrow = 1,
                      labels = c('', 'c.',''),
                      widths = c(.01,.70,.33),
                      hjust = .3)

explPlot <- ggarrange(explPlot1, explPlot2,
                      ncol = 1, nrow = 2)
explPlot

# save
ggsave('EWS_fig5.png', explPlot, device = NULL, path = aPath,
       width = 6.5, height = 6, dpi = 600)
```

