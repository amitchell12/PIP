---
title: "Beyond Bias - Analysis Code"
author: "A.G. Mitchell"
date: "2022-10-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

# Setting paths for raw data and analysis
```{r}
dPath <- '/Users/au706616/Documents/Experiments/PIPTOT/LBTraw'
aPath <- '/Users/au706616/Documents/Experiments/PIPTOT/analysis'

datname <- 'LBTraw_120.csv'
qualname <- 'QUALraw.csv'

# load raw and qual data
bisectData <- read.csv(file.path(dPath,datname)) 
qualData <- read.csv(file.path(dPath,qualname)) 
```

# Quick data quality checks - main data
```{r}
# first get an idea of all participants (prolific IDs)
nres <- aggregate(acc~prolific_id, length, data=bisectData)
length(nres$prolific_id)

# n particiants removed who failed audio check/too few trials
nAudio <- dplyr::filter(nres, acc < 200)
id_x <- nAudio$prolific_id #identifying participants to be removed

# count void trials - identify excessive
void <- dplyr::filter(bisectData, void_trial == 1)
nVoid <- aggregate(void_trial~prolific_id, length, data=void)

compareVoid <- merge(nVoid, nres, by = 'prolific_id')

# final audio check, correct?
finalAudio <- bisectData[bisectData$response_audio_kbd_final == 7 ,]
finalAudio <- finalAudio[, c(225,237)]
length(finalAudio$queryParams_PROLIFIC_PID)

# filter trials so audio = passed, this removes audio step and filters participants who failed
bisectData <- dplyr::filter(bisectData, audio_passed == 1)
# then remove void trials
bisectData <- dplyr::filter(bisectData, void_trial == 0 & practice == 0)
# number of trials for each participant with void and practice removed
ntrials <- aggregate(bisect_x~prolific_id, length, data=bisectData)
# order by prolific id for easy identification
ntrials <- ntrials[order(ntrials$prolific_id) ,]
# identify any participants with too few trials (again)
## ADD THE ABOVE ID_X TO THIS ID_X - AND FIND OUT HOW
id_x <- append(id_x, ntrials$prolific_id[ntrials$bisect_x < 192]) #fewer than total number of trials

# remove participants with too few trials from full data set
bisectData <- filter(bisectData, !(prolific_id %in% id_x))
# n remaining participants
nvalid <- aggregate(bisect_x~prolific_id, length, data=bisectData)
length(nvalid$prolific_id)
# narrow down data-frame to relevant columns only - putting important first
all_dat <- bisectData[, c(224,11,12,289,211,212,274,275,214,36,37,46,89,164,165,206,207,
                          208,216:218,222,228,229,237,251,352,356,319,321,386,388)]

# Qualitative data
# Then merge with qualitative data
```

# Quick data quality checks - first 10 participants
This is slightly different than above because PIDs were not recorded for the first 10
participants. Have manually matched all JATOS IDs with PIDs

Run the same steps as above on these data
```{r}
# do the same as above for the first 10 participants (collected seperately)
# then combine their data
dat10name <- 'LBTraw_first10.csv'
qual10name <- 'QUALraw_first10.csv'

# first only load the raw data because demographic is a little useless at this stage
bisect10Data <- read.csv(file.path(dPath,dat10name)) 
qual10Data <- read.csv(file.path(dPath,qual10name)) 

# same filtering as above
# first get an idea of all participants (prolific IDs)
nres10 <- aggregate(acc~jatosStudyResultId, length, data=bisect10Data)
length(nres10$jatosStudyResultId)

# n particiants removed who failed audio check/too few trials
nAudio10 <- dplyr::filter(nres10, acc < 200)
# count void trials
void10 <- dplyr::filter(bisect10Data, void_trial == 1)
nVoid10 <- aggregate(void_trial~jatosStudyResultId, length, data=void10)
# remove participants with excessive void trials
## how to do this??

# final audio check, correct?
finalAudio10 <- bisect10Data[bisect10Data$response_audio_kbd_final == 7 ,]
finalAudio10 <- finalAudio10[, c(224,198)]

# filter trials so audio = passed, this removes audio step and filters participants who failed
bisect10Data <- dplyr::filter(bisect10Data, audio_passed == 1)
# then remove void trials
bisect10Data <- dplyr::filter(bisect10Data, void_trial == 0 & practice == 0)
# number of trials for each participant with void and practice removed
ntrials10 <- aggregate(bisect_x~jatosStudyResultId, length, data=bisect10Data)

# narrow down data-frame for correct columns only
dat10 <- bisect10Data[, c(224,11,12,289,211,212,274,275,214,36,37,46,89,164,165,206,207,
                          208,216:218,222,228,229,237,251,352,356,319,321,386,388)]

## Qualitative data
# flag PIDs with no code & no data
nPID <- c('611e1eee7989eadcee23045c', '6025df3ed83eed206142329a', '6130d846086f43ecd225d128')
# qualitative data
# first, some renaming
names(qual10Data)[2] <- 'prolific_id'
names(qual10Data)[3] <- 'gender'
names(qual10Data)[4] <- 'age'
# remove no code PIDs from quantitative
qual10Data <- filter(qual10Data, !(prolific_id %in% nPID))
# add JATOS IDs
# merge relevant PIDS with jatos IDs, to merge data-frames
qual10Data$jatosStudyResultId <- ntrials10$jatosStudyResultId


```

# Screen calibration
Check and remove participants where calib and dot locations do not match 
Criteria:

```{r}
# Calibration check

# Get final participant numbers!
```

# Data wrangling!

```{r}
# check bisection of all lines - first calculate bisection error
bisectData$bisect_error <- bisectData$bisect_x - bisectData$calib_loc_midy_x
# convert error into mm
bisectData$bisect_error <- bisectData$bisect_error/bisectData$pix_permm

# mean bisect error across lines & sounds
bisectError_sound <- aggregate(bisect_error ~ sound*right_mm*left_mm*jatosStudyResultId, 
                         mean, data = bisectData)
# mean bisect error across lines & blocks
bisectData$block_count <- ifelse(is.na(bisectData$count_block_2_sequence), 1, 2) #identifying block
bisectError_time <- aggregate(bisect_error ~ block_count*right_mm*left_mm*jatosStudyResultId, 
                         mean, data = bisectData)

# time of breaks
bisectData$break_length <- bisectData$time_break_time_stamp - bisectData$time_block_one_end 
bisectData$break_length <- bisectData$break_length/100 #in seconds
```
